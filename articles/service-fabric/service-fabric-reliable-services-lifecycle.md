---
title: "aaaOverview Olá ciclo de vida dos Reliable Services do Azure Service Fabric | Microsoft Docs"
description: "Saiba mais sobre eventos de ciclo de vida de diferentes Olá nos serviços de fiáveis de Service Fabric"
services: Service-Fabric
documentationcenter: .net
author: masnider
manager: timlt
editor: vturecek;
ms.assetid: 
ms.service: Service-Fabric
ms.devlang: dotnet
ms.topic: article
ms.tgt_pltfrm: NA
ms.workload: NA
ms.date: 08/18/2017
ms.author: masnider
ms.openlocfilehash: 0d75ed5ee7cda85ac9af6a02e160727277804a2b
ms.sourcegitcommit: 523283cc1b3c37c428e77850964dc1c33742c5f0
ms.translationtype: MT
ms.contentlocale: pt-PT
ms.lasthandoff: 10/06/2017
---
# <a name="reliable-services-lifecycle-overview"></a><span data-ttu-id="84c99-103">Descrição geral do ciclo de vida de serviços fiável</span><span class="sxs-lookup"><span data-stu-id="84c99-103">Reliable services lifecycle overview</span></span>
> [!div class="op_single_selector"]
> * [<span data-ttu-id="84c99-104">C# no Windows</span><span class="sxs-lookup"><span data-stu-id="84c99-104">C# on Windows</span></span>](service-fabric-reliable-services-lifecycle.md)
> * [<span data-ttu-id="84c99-105">Java em Linux</span><span class="sxs-lookup"><span data-stu-id="84c99-105">Java on Linux</span></span>](service-fabric-reliable-services-lifecycle-java.md)
>
>

<span data-ttu-id="84c99-106">Quando pensar sobre Olá ciclos de vida dos Reliable Services, Olá Noções básicas do ciclo de vida de Olá são Olá mais importante.</span><span class="sxs-lookup"><span data-stu-id="84c99-106">When thinking about hello lifecycles of Reliable Services, hello basics of hello lifecycle are hello most important.</span></span> <span data-ttu-id="84c99-107">Em geral:</span><span class="sxs-lookup"><span data-stu-id="84c99-107">In general:</span></span>

- <span data-ttu-id="84c99-108">Durante o arranque</span><span class="sxs-lookup"><span data-stu-id="84c99-108">During Startup</span></span>
  - <span data-ttu-id="84c99-109">Os serviços são construídos</span><span class="sxs-lookup"><span data-stu-id="84c99-109">Services are constructed</span></span>
  - <span data-ttu-id="84c99-110">Têm um tooconstruct oportunidade e devolver zero ou mais serviços de escuta</span><span class="sxs-lookup"><span data-stu-id="84c99-110">They have an opportunity tooconstruct and return zero or more listeners</span></span>
  - <span data-ttu-id="84c99-111">Os serviços de escuta devolvidos estão abertos, permitir a comunicação com o serviço de Olá</span><span class="sxs-lookup"><span data-stu-id="84c99-111">Any returned listeners are opened, allowing communication with hello service</span></span>
  - <span data-ttu-id="84c99-112">runasync com do serviço de Olá se chama o método, permitindo Olá serviço toodo execução longa ou em segundo plano de trabalho</span><span class="sxs-lookup"><span data-stu-id="84c99-112">hello Service's RunAsync method is called, allowing hello service toodo long running or background work</span></span>
- <span data-ttu-id="84c99-113">Durante o encerramento</span><span class="sxs-lookup"><span data-stu-id="84c99-113">During shutdown</span></span>
  - <span data-ttu-id="84c99-114">Olá cancelamento token transmitido tooRunAsync foi cancelada e os serviços de escuta de Olá estão fechados</span><span class="sxs-lookup"><span data-stu-id="84c99-114">hello cancellation token passed tooRunAsync is canceled, and hello listeners are closed</span></span>
  - <span data-ttu-id="84c99-115">Assim que estiver concluído, é de objeto de serviço Olá próprio destructed</span><span class="sxs-lookup"><span data-stu-id="84c99-115">Once that is complete, hello service object itself is destructed</span></span>

<span data-ttu-id="84c99-116">Existem detalhes em torno Olá exato de ordenação destes eventos.</span><span class="sxs-lookup"><span data-stu-id="84c99-116">There are details around hello exact ordering of these events.</span></span> <span data-ttu-id="84c99-117">Em particular, ordem de Olá de eventos podem ser alteradas ligeiramente dependendo se o serviço fiável de Olá é Stateless ou de monitorização de estado.</span><span class="sxs-lookup"><span data-stu-id="84c99-117">In particular, hello order of events may change slightly depending on whether hello Reliable Service is Stateless or Stateful.</span></span> <span data-ttu-id="84c99-118">Além disso, para os serviços com monitorização de estado, temos toodeal com cenário de comutação primário Olá.</span><span class="sxs-lookup"><span data-stu-id="84c99-118">In addition, for stateful services, we have toodeal with hello Primary swap scenario.</span></span> <span data-ttu-id="84c99-119">Durante esta sequência e função Olá de principal é tooanother transferidos réplica (ou volta) sem serviço Olá encerrar.</span><span class="sxs-lookup"><span data-stu-id="84c99-119">During this sequence, hello role of Primary is transferred tooanother replica (or comes back) without hello service shutting down.</span></span> <span data-ttu-id="84c99-120">Por fim, temos toothink sobre as condições de erro ou falha.</span><span class="sxs-lookup"><span data-stu-id="84c99-120">Finally, we have toothink about error or failure conditions.</span></span>

## <a name="stateless-service-startup"></a><span data-ttu-id="84c99-121">Arranque do serviço sem monitorização de estado</span><span class="sxs-lookup"><span data-stu-id="84c99-121">Stateless service startup</span></span>
<span data-ttu-id="84c99-122">Olá ciclo de vida de um serviço sem monitorização de estado é bastante simples.</span><span class="sxs-lookup"><span data-stu-id="84c99-122">hello lifecycle of a stateless service is fairly straightforward.</span></span> <span data-ttu-id="84c99-123">Segue-se a ordem de Olá de eventos:</span><span class="sxs-lookup"><span data-stu-id="84c99-123">Here's hello order of events:</span></span>

1. <span data-ttu-id="84c99-124">Olá serviço é construído</span><span class="sxs-lookup"><span data-stu-id="84c99-124">hello Service is constructed</span></span>
2. <span data-ttu-id="84c99-125">Em seguida, em paralelas duas coisas ocorrer:</span><span class="sxs-lookup"><span data-stu-id="84c99-125">Then, in parallel two things happen:</span></span>
    - <span data-ttu-id="84c99-126">`StatelessService.CreateServiceInstanceListeners()`é invocada e quaisquer serviços de escuta devolvidos estão abertos.</span><span class="sxs-lookup"><span data-stu-id="84c99-126">`StatelessService.CreateServiceInstanceListeners()` is invoked and any returned listeners are Opened.</span></span> <span data-ttu-id="84c99-127">`ICommunicationListener.OpenAsync()`é chamado para cada serviço de escuta</span><span class="sxs-lookup"><span data-stu-id="84c99-127">`ICommunicationListener.OpenAsync()` is called on each listener</span></span>
    - <span data-ttu-id="84c99-128">Olá do serviço `StatelessService.RunAsync()` método é denominado</span><span class="sxs-lookup"><span data-stu-id="84c99-128">hello service's `StatelessService.RunAsync()` method is called</span></span>
3. <span data-ttu-id="84c99-129">Se estiver presente, hello do serviço `StatelessService.OnOpenAsync()` método é chamado.</span><span class="sxs-lookup"><span data-stu-id="84c99-129">If present, hello service's `StatelessService.OnOpenAsync()` method is called.</span></span> <span data-ttu-id="84c99-130">Esta é uma substituição invulgar, mas está disponível.</span><span class="sxs-lookup"><span data-stu-id="84c99-130">This is an uncommon override, but it is available.</span></span>

<span data-ttu-id="84c99-131">É importante toonote que não há nenhum ordenação entre Olá chamadas toocreate e os serviços de escuta de Olá aberta e runasync com.</span><span class="sxs-lookup"><span data-stu-id="84c99-131">It is important toonote that there is no ordering between hello calls toocreate and open hello listeners and RunAsync.</span></span> <span data-ttu-id="84c99-132">Serviços de escuta de Olá poderão abrir antes runasync com é iniciado.</span><span class="sxs-lookup"><span data-stu-id="84c99-132">hello listeners may open before RunAsync is started.</span></span> <span data-ttu-id="84c99-133">Da mesma forma, runasync com poderá acabar invocado antes de serviços de escuta de comunicação de Olá abertos ou mesmo foi construídos.</span><span class="sxs-lookup"><span data-stu-id="84c99-133">Similarly, RunAsync may end up invoked before hello communication listeners are open or have even been constructed.</span></span> <span data-ttu-id="84c99-134">Se for necessária qualquer sincronização, será deixada como um implementador de toohello exercício.</span><span class="sxs-lookup"><span data-stu-id="84c99-134">If any synchronization is required, it is left as an exercise toohello implementer.</span></span> <span data-ttu-id="84c99-135">Soluções comuns:</span><span class="sxs-lookup"><span data-stu-id="84c99-135">Common solutions:</span></span>

  - <span data-ttu-id="84c99-136">Por vezes, os serviços de escuta não podem funcionar até que outras informações é criado ou trabalho efectuadas.</span><span class="sxs-lookup"><span data-stu-id="84c99-136">Sometimes listeners can't function until some other information is created or work done.</span></span> <span data-ttu-id="84c99-137">Para os serviços sem monitorização de estado de trabalho pode normalmente ser feito noutras localizações, tais como:</span><span class="sxs-lookup"><span data-stu-id="84c99-137">For stateless services that work can usually be done in other locations, such as:</span></span> 
    - <span data-ttu-id="84c99-138">no construtor do serviço de Olá</span><span class="sxs-lookup"><span data-stu-id="84c99-138">in hello service's constructor</span></span>
    - <span data-ttu-id="84c99-139">durante a Olá `CreateServiceInstanceListeners()` chamar</span><span class="sxs-lookup"><span data-stu-id="84c99-139">during hello `CreateServiceInstanceListeners()` call</span></span>
    - <span data-ttu-id="84c99-140">como parte de construção de Olá do serviço de escuta de Olá próprio</span><span class="sxs-lookup"><span data-stu-id="84c99-140">as a part of hello construction of hello listener itself</span></span>
  - <span data-ttu-id="84c99-141">Por vezes, hello código runasync com pretende toostart até que os serviços de escuta de Olá estão abertos.</span><span class="sxs-lookup"><span data-stu-id="84c99-141">Sometimes hello code in RunAsync does not want toostart until hello listeners are open.</span></span> <span data-ttu-id="84c99-142">Neste caso coordenação adicional é necessária.</span><span class="sxs-lookup"><span data-stu-id="84c99-142">In this case additional coordination is necessary.</span></span> <span data-ttu-id="84c99-143">Uma solução comum é algumas sinalizador dentro de serviços de escuta de Olá que indicam quando estes estiverem concluídas.</span><span class="sxs-lookup"><span data-stu-id="84c99-143">One common solution is some flag within hello listeners indicating when they have completed.</span></span> <span data-ttu-id="84c99-144">Este sinalizador, em seguida, é verificado em runasync com antes de continuar o trabalho tooactual.</span><span class="sxs-lookup"><span data-stu-id="84c99-144">This flag is then checked in RunAsync before continuing tooactual work.</span></span>

## <a name="stateless-service-shutdown"></a><span data-ttu-id="84c99-145">Encerramento do serviço sem monitorização de estado</span><span class="sxs-lookup"><span data-stu-id="84c99-145">Stateless service shutdown</span></span>
<span data-ttu-id="84c99-146">Quando encerrar um serviço sem monitorização de estado, hello mesmo padrão é seguido, apenas na inversa:</span><span class="sxs-lookup"><span data-stu-id="84c99-146">When shutting down a stateless service, hello same pattern is followed, just in reverse:</span></span>

1. <span data-ttu-id="84c99-147">Em paralelo</span><span class="sxs-lookup"><span data-stu-id="84c99-147">In parallel</span></span>
    - <span data-ttu-id="84c99-148">Quaisquer serviços de escuta abertos são fechados.</span><span class="sxs-lookup"><span data-stu-id="84c99-148">Any open listeners are Closed.</span></span> <span data-ttu-id="84c99-149">`ICommunicationListener.CloseAsync()`é chamado para cada serviço de escuta.</span><span class="sxs-lookup"><span data-stu-id="84c99-149">`ICommunicationListener.CloseAsync()` is called on each listener.</span></span>
    - <span data-ttu-id="84c99-150">token de cancelamento Olá passou demasiado`RunAsync()` foi cancelada.</span><span class="sxs-lookup"><span data-stu-id="84c99-150">hello cancellation token passed too`RunAsync()` is canceled.</span></span> <span data-ttu-id="84c99-151">Do token de verificação Olá cancelamento `IsCancellationRequested` propriedade devolve true e se a chamada do token de Olá `ThrowIfCancellationRequested` método gera um `OperationCanceledException`.</span><span class="sxs-lookup"><span data-stu-id="84c99-151">Checking hello cancellation token's `IsCancellationRequested` property returns true, and if called hello token's `ThrowIfCancellationRequested` method throws an `OperationCanceledException`.</span></span>
2. <span data-ttu-id="84c99-152">Uma vez `CloseAsync()` conclusão em cada serviço de escuta e `RunAsync()` também estiver concluída, do serviço de Olá `StatelessService.OnCloseAsync()` se chama o método, se estiver presente.</span><span class="sxs-lookup"><span data-stu-id="84c99-152">Once `CloseAsync()` completes on each listener and `RunAsync()` also completes, hello service's `StatelessService.OnCloseAsync()` method is called, if present.</span></span> <span data-ttu-id="84c99-153">É toooverride invulgar `StatelessService.OnCloseAsync()`.</span><span class="sxs-lookup"><span data-stu-id="84c99-153">It is uncommon toooverride `StatelessService.OnCloseAsync()`.</span></span>
3. <span data-ttu-id="84c99-154">Depois de `StatelessService.OnCloseAsync()` estiver concluída, o objeto de serviço Olá é destructed</span><span class="sxs-lookup"><span data-stu-id="84c99-154">After `StatelessService.OnCloseAsync()` completes, hello service object is destructed</span></span>

## <a name="stateful-service-startup"></a><span data-ttu-id="84c99-155">Arranque de serviço com estado</span><span class="sxs-lookup"><span data-stu-id="84c99-155">Stateful service Startup</span></span>
<span data-ttu-id="84c99-156">Os serviços com monitorização de estado têm um serviços toostateless padrão semelhante, com algumas alterações.</span><span class="sxs-lookup"><span data-stu-id="84c99-156">Stateful services have a similar pattern toostateless services, with a few changes.</span></span> <span data-ttu-id="84c99-157">Quando a partir de um serviço com monitorização de estado, ordem de Olá de eventos é o seguinte:</span><span class="sxs-lookup"><span data-stu-id="84c99-157">When starting up a stateful service, hello order of events is as follows:</span></span>

1. <span data-ttu-id="84c99-158">Olá serviço é construído</span><span class="sxs-lookup"><span data-stu-id="84c99-158">hello Service is constructed</span></span>
2. <span data-ttu-id="84c99-159">`StatefulServiceBase.OnOpenAsync()`é chamado.</span><span class="sxs-lookup"><span data-stu-id="84c99-159">`StatefulServiceBase.OnOpenAsync()` is called.</span></span> <span data-ttu-id="84c99-160">Isto é uncommonly substituí-lo no serviço de Olá.</span><span class="sxs-lookup"><span data-stu-id="84c99-160">This is uncommonly overridden in hello service.</span></span>
3. <span data-ttu-id="84c99-161">Olá seguintes ações ocorrem em paralelo</span><span class="sxs-lookup"><span data-stu-id="84c99-161">hello following things happen in parallel</span></span>
    - <span data-ttu-id="84c99-162">`StatefulServiceBase.CreateServiceReplicaListeners()`é invocado</span><span class="sxs-lookup"><span data-stu-id="84c99-162">`StatefulServiceBase.CreateServiceReplicaListeners()` is invoked</span></span> 
      - <span data-ttu-id="84c99-163">Se o serviço de Olá for um site primário todos os serviços de escuta devolvidos estão abertos.</span><span class="sxs-lookup"><span data-stu-id="84c99-163">If hello service is a Primary all returned listeners are Opened.</span></span> <span data-ttu-id="84c99-164">`ICommunicationListener.OpenAsync()`é chamado para cada serviço de escuta.</span><span class="sxs-lookup"><span data-stu-id="84c99-164">`ICommunicationListener.OpenAsync()` is called on each listener.</span></span>
      - <span data-ttu-id="84c99-165">Se o serviço de Olá uma secundária, só esses serviços de escuta marcada como `ListenOnSecondary = true` estão abertas.</span><span class="sxs-lookup"><span data-stu-id="84c99-165">If hello service is a Secondary, only those listeners marked as `ListenOnSecondary = true` are opened.</span></span> <span data-ttu-id="84c99-166">É menos comum ter os serviços de escuta que são abertos em bases de dados secundárias.</span><span class="sxs-lookup"><span data-stu-id="84c99-166">Having listeners that are open on Secondaries is less common.</span></span>
    - <span data-ttu-id="84c99-167">Olá se Olá serviço atualmente é um serviço Olá primário, `StatefulServiceBase.RunAsync()` método é denominado</span><span class="sxs-lookup"><span data-stu-id="84c99-167">hello if hello Service is currently a Primary, hello service's `StatefulServiceBase.RunAsync()` method is called</span></span>
4. <span data-ttu-id="84c99-168">Depois de todos os hello do serviço de escuta de réplica `OpenAsync()` chamadas concluir e `RunAsync()` denomina-se, `StatefulServiceBase.OnChangeRoleAsync()` é chamado.</span><span class="sxs-lookup"><span data-stu-id="84c99-168">Once all hello replica listener's `OpenAsync()` calls complete and `RunAsync()` is called, `StatefulServiceBase.OnChangeRoleAsync()` is called.</span></span> <span data-ttu-id="84c99-169">Isto é uncommonly substituí-lo no serviço de Olá.</span><span class="sxs-lookup"><span data-stu-id="84c99-169">This is uncommonly overridden in hello service.</span></span>

<span data-ttu-id="84c99-170">Da mesma forma toostateless serviços, não existe nenhum coordenação entre ordem Olá no qual Olá são criados e abrir os serviços de escuta e quando runasync com é chamado.</span><span class="sxs-lookup"><span data-stu-id="84c99-170">Similarly toostateless services, there's no coordination between hello order in which hello listeners are created and opened and when RunAsync is called.</span></span> <span data-ttu-id="84c99-171">Se precisar de coordenação, soluções Olá são muito Olá mesmo.</span><span class="sxs-lookup"><span data-stu-id="84c99-171">If you need coordination, hello solutions are much hello same.</span></span> <span data-ttu-id="84c99-172">Há um cenário adicional: dizer que as chamadas de Olá a chegar ao serviços de escuta de comunicação de Olá necessitam de informações mantidas dentro de alguns [coleções fiável](service-fabric-reliable-services-reliable-collections.md).</span><span class="sxs-lookup"><span data-stu-id="84c99-172">THere is one additional case: say that hello calls arriving at hello communication listeners require information kept inside some [Reliable Collections](service-fabric-reliable-services-reliable-collections.md).</span></span> <span data-ttu-id="84c99-173">Porque os serviços de escuta de comunicação de Olá foi aberta antes de coleções fiável Olá são legíveis ou gravável e antes de runasync com conseguiu iniciar, algumas adicional coordenação é necessária.</span><span class="sxs-lookup"><span data-stu-id="84c99-173">Because hello communication listeners could open before hello reliable collections are readable or writeable, and before RunAsync could start, some additional coordination is necessary.</span></span> <span data-ttu-id="84c99-174">solução mais simples e mais comuns de Olá destina-se tooreturn de serviços de escuta de comunicação de Olá algum código de erro hello do cliente utiliza tooknow tooretry Olá pedido.</span><span class="sxs-lookup"><span data-stu-id="84c99-174">hello simplest and most common solution is for hello communication listeners tooreturn some error code that hello client uses tooknow tooretry hello request.</span></span>

## <a name="stateful-service-shutdown"></a><span data-ttu-id="84c99-175">Encerramento de serviço com estado</span><span class="sxs-lookup"><span data-stu-id="84c99-175">Stateful service Shutdown</span></span>
<span data-ttu-id="84c99-176">Da mesma forma tooStateless serviços, eventos de ciclo de vida de Olá durante o encerramento são Olá mesmo como durante o arranque, mas invertido.</span><span class="sxs-lookup"><span data-stu-id="84c99-176">Similarly tooStateless services, hello lifecycle events during shutdown are hello same as during startup, but reversed.</span></span> <span data-ttu-id="84c99-177">Quando um serviço com monitorização de estado está a ser encerrado, hello eventos seguintes ocorrem:</span><span class="sxs-lookup"><span data-stu-id="84c99-177">When a stateful service is being shut down, hello following events occur:</span></span>

1. <span data-ttu-id="84c99-178">Em paralelo</span><span class="sxs-lookup"><span data-stu-id="84c99-178">In parallel</span></span>
    - <span data-ttu-id="84c99-179">Quaisquer serviços de escuta abertos são fechados.</span><span class="sxs-lookup"><span data-stu-id="84c99-179">Any open listeners are Closed.</span></span> <span data-ttu-id="84c99-180">`ICommunicationListener.CloseAsync()`é chamado para cada serviço de escuta.</span><span class="sxs-lookup"><span data-stu-id="84c99-180">`ICommunicationListener.CloseAsync()` is called on each listener.</span></span>
    - <span data-ttu-id="84c99-181">token de cancelamento Olá passou demasiado`RunAsync()` foi cancelada.</span><span class="sxs-lookup"><span data-stu-id="84c99-181">hello cancellation token passed too`RunAsync()` is canceled.</span></span> <span data-ttu-id="84c99-182">Do token de verificação Olá cancelamento `IsCancellationRequested` propriedade devolve true e se a chamada do token de Olá `ThrowIfCancellationRequested` método gera um `OperationCanceledException`.</span><span class="sxs-lookup"><span data-stu-id="84c99-182">Checking hello cancellation token's `IsCancellationRequested` property returns true, and if called hello token's `ThrowIfCancellationRequested` method throws an `OperationCanceledException`.</span></span>
2. <span data-ttu-id="84c99-183">Uma vez `CloseAsync()` conclusão em cada serviço de escuta e `RunAsync()` também estiver concluída, do serviço de Olá `StatefulServiceBase.OnChangeRoleAsync()` é chamado.</span><span class="sxs-lookup"><span data-stu-id="84c99-183">Once `CloseAsync()` completes on each listener and `RunAsync()` also completes, hello service's `StatefulServiceBase.OnChangeRoleAsync()` is called.</span></span> <span data-ttu-id="84c99-184">(Isto é uncommonly substituído no serviço de Olá.)</span><span class="sxs-lookup"><span data-stu-id="84c99-184">(This is uncommonly overridden in hello service.)</span></span>
    - <span data-ttu-id="84c99-185">A aguardar runasync com toocomplete é apenas necessário se esta réplica de serviço foi um site primário.</span><span class="sxs-lookup"><span data-stu-id="84c99-185">Waiting for RunAsync toocomplete is only necessary if this service replica was a Primary.</span></span>
3. <span data-ttu-id="84c99-186">Uma vez Olá `StatefulServiceBase.OnChangeRoleAsync()` método estiver concluída, hello `StatefulServiceBase.OnCloseAsync()` método é chamado.</span><span class="sxs-lookup"><span data-stu-id="84c99-186">Once hello `StatefulServiceBase.OnChangeRoleAsync()` method completes, hello `StatefulServiceBase.OnCloseAsync()` method is called.</span></span> <span data-ttu-id="84c99-187">Esta é uma substituição invulgar, mas está disponível.</span><span class="sxs-lookup"><span data-stu-id="84c99-187">This is an uncommon override, but it is available.</span></span>
3. <span data-ttu-id="84c99-188">Depois de `StatefulServiceBase.OnCloseAsync()` estiver concluída, o objeto de serviço Olá é destructed.</span><span class="sxs-lookup"><span data-stu-id="84c99-188">After `StatefulServiceBase.OnCloseAsync()` completes, hello service object is destructed.</span></span>

## <a name="stateful-service-primary-swaps"></a><span data-ttu-id="84c99-189">Trocas de principal de serviço com estado</span><span class="sxs-lookup"><span data-stu-id="84c99-189">Stateful service primary swaps</span></span>
<span data-ttu-id="84c99-190">Enquanto um serviço com estado estiver em execução, só hello réplicas primárias que serviços com monitorização de estado de tem os respetivos serviços de escuta de comunicação abertos e o respetivo método runasync com chamado.</span><span class="sxs-lookup"><span data-stu-id="84c99-190">While a stateful service is running, only hello Primary replicas of that stateful services have their communication listeners opened and their RunAsync method called.</span></span> <span data-ttu-id="84c99-191">Secundário são construídos mas Consulte não chamadas adicionais.</span><span class="sxs-lookup"><span data-stu-id="84c99-191">Secondary are constructed but see no further calls.</span></span> <span data-ttu-id="84c99-192">Enquanto um serviço com estado estiver em execução no entanto, a qual a réplica está atualmente Olá principal pode alterar.</span><span class="sxs-lookup"><span data-stu-id="84c99-192">While a stateful service is running however, which replica is currently hello Primary can change.</span></span> <span data-ttu-id="84c99-193">O que significa em termos de eventos de ciclo de vida de Olá que pode ver uma réplica? Olá comportamento Olá réplica com monitorização de estado vê depende é réplica Olá que está a ser despromovida ou promovida durante a troca de Olá.</span><span class="sxs-lookup"><span data-stu-id="84c99-193">What does this mean in terms of hello lifecycle events that a replica can see? hello behavior hello stateful replica sees depends on whether it is hello replica being demoted or promoted during hello swap.</span></span>

### <a name="for-hello-primary-being-demoted"></a><span data-ttu-id="84c99-194">Para Olá primário que está a ser despromovido</span><span class="sxs-lookup"><span data-stu-id="84c99-194">For hello primary being demoted</span></span>
<span data-ttu-id="84c99-195">Service Fabric tem toostop esta réplica processamento de mensagens e sair de qualquer trabalho em segundo plano que esteja a executar.</span><span class="sxs-lookup"><span data-stu-id="84c99-195">Service Fabric needs this replica toostop processing messages and quit any background work it is doing.</span></span> <span data-ttu-id="84c99-196">Como resultado, este passo procura semelhante toowhen Olá serviço está a ser encerrado.</span><span class="sxs-lookup"><span data-stu-id="84c99-196">As a result, this step looks similar toowhen hello service is being shut down.</span></span> <span data-ttu-id="84c99-197">Uma diferença é que Olá serviço não se encontra destructed ou fechado, uma vez que continua a ser como uma secundária.</span><span class="sxs-lookup"><span data-stu-id="84c99-197">One difference is that hello Service isn't destructed or closed since it remains as a Secondary.</span></span> <span data-ttu-id="84c99-198">é denominado Olá APIs os seguintes:</span><span class="sxs-lookup"><span data-stu-id="84c99-198">hello following APIs are called:</span></span>

1. <span data-ttu-id="84c99-199">Em paralelo</span><span class="sxs-lookup"><span data-stu-id="84c99-199">In parallel</span></span>
    - <span data-ttu-id="84c99-200">Quaisquer serviços de escuta abertos são fechados.</span><span class="sxs-lookup"><span data-stu-id="84c99-200">Any open listeners are Closed.</span></span> <span data-ttu-id="84c99-201">`ICommunicationListener.CloseAsync()`é chamado para cada serviço de escuta.</span><span class="sxs-lookup"><span data-stu-id="84c99-201">`ICommunicationListener.CloseAsync()` is called on each listener.</span></span>
    - <span data-ttu-id="84c99-202">token de cancelamento Olá passou demasiado`RunAsync()` foi cancelada.</span><span class="sxs-lookup"><span data-stu-id="84c99-202">hello cancellation token passed too`RunAsync()` is canceled.</span></span> <span data-ttu-id="84c99-203">Do token de verificação Olá cancelamento `IsCancellationRequested` propriedade devolve true e se a chamada do token de Olá `ThrowIfCancellationRequested` método gera um `OperationCanceledException`.</span><span class="sxs-lookup"><span data-stu-id="84c99-203">Checking hello cancellation token's `IsCancellationRequested` property returns true, and if called hello token's `ThrowIfCancellationRequested` method throws an `OperationCanceledException`.</span></span>
2. <span data-ttu-id="84c99-204">Uma vez `CloseAsync()` conclusão em cada serviço de escuta e `RunAsync()` também estiver concluída, do serviço de Olá `StatefulServiceBase.OnChangeRoleAsync()` é chamado.</span><span class="sxs-lookup"><span data-stu-id="84c99-204">Once `CloseAsync()` completes on each listener and `RunAsync()` also completes, hello service's `StatefulServiceBase.OnChangeRoleAsync()` is called.</span></span> <span data-ttu-id="84c99-205">Isto é uncommonly substituí-lo no serviço de Olá.</span><span class="sxs-lookup"><span data-stu-id="84c99-205">This is uncommonly overridden in hello service.</span></span>

### <a name="for-hello-secondary-being-promoted"></a><span data-ttu-id="84c99-206">A ser promovido para Olá secundário</span><span class="sxs-lookup"><span data-stu-id="84c99-206">For hello secondary being promoted</span></span>
<span data-ttu-id="84c99-207">Da mesma forma, o Service Fabric tem toostart esta réplica escutar mensagens na transmissão de Olá e iniciar quaisquer tarefas em segundo plano que cares sobre.</span><span class="sxs-lookup"><span data-stu-id="84c99-207">Similarly, Service Fabric needs this replica toostart listening for messages on hello wire and start any background tasks it cares about.</span></span> <span data-ttu-id="84c99-208">Como resultado, parece este processo é criado o serviço de Olá toowhen semelhante, exceto essa réplica Olá próprio já existe.</span><span class="sxs-lookup"><span data-stu-id="84c99-208">As a result, this process looks similar toowhen hello service is created, except that hello replica itself already exists.</span></span> <span data-ttu-id="84c99-209">é denominado Olá APIs os seguintes:</span><span class="sxs-lookup"><span data-stu-id="84c99-209">hello following APIs are called:</span></span>

1. <span data-ttu-id="84c99-210">Em paralelo</span><span class="sxs-lookup"><span data-stu-id="84c99-210">In parallel</span></span>
    - <span data-ttu-id="84c99-211">`StatefulServiceBase.CreateServiceReplicaListeners()`é invocada e quaisquer serviços de escuta devolvidos estão abertos.</span><span class="sxs-lookup"><span data-stu-id="84c99-211">`StatefulServiceBase.CreateServiceReplicaListeners()` is invoked and any returned listeners are Opened.</span></span> <span data-ttu-id="84c99-212">`ICommunicationListener.OpenAsync()`é chamado para cada serviço de escuta.</span><span class="sxs-lookup"><span data-stu-id="84c99-212">`ICommunicationListener.OpenAsync()` is called on each listener.</span></span>
    - <span data-ttu-id="84c99-213">Olá do serviço `StatefulServiceBase.RunAsync()` método é denominado</span><span class="sxs-lookup"><span data-stu-id="84c99-213">hello service's `StatefulServiceBase.RunAsync()` method is called</span></span>
2. <span data-ttu-id="84c99-214">Depois de todos os hello do serviço de escuta de réplica `OpenAsync()` chamadas concluir e `RunAsync()` ter sido chamado `StatefulServiceBase.OnChangeRoleAsync()` é chamado.</span><span class="sxs-lookup"><span data-stu-id="84c99-214">Once all hello replica listener's `OpenAsync()` calls complete and `RunAsync()` has been called,  `StatefulServiceBase.OnChangeRoleAsync()` is called.</span></span> <span data-ttu-id="84c99-215">Isto é uncommonly substituí-lo no serviço de Olá.</span><span class="sxs-lookup"><span data-stu-id="84c99-215">This is uncommonly overridden in hello service.</span></span>

### <a name="common-issues-during-stateful-service-shutdown-and-primary-demotion"></a><span data-ttu-id="84c99-216">Problemas comuns durante o encerramento do serviço com monitorização de estado e despromoção primária</span><span class="sxs-lookup"><span data-stu-id="84c99-216">Common issues during stateful service shutdown and primary demotion</span></span>
<span data-ttu-id="84c99-217">Alterações do Service Fabric Olá principal de um serviço com monitorização de estado para diversos motivos.</span><span class="sxs-lookup"><span data-stu-id="84c99-217">Service Fabric changes hello Primary of a stateful service for a variety of reasons.</span></span> <span data-ttu-id="84c99-218">Hello mais comuns são [cluster reequilíbrio](service-fabric-cluster-resource-manager-balancing.md) e [atualização da aplicação](service-fabric-application-upgrade.md).</span><span class="sxs-lookup"><span data-stu-id="84c99-218">hello most common are [cluster rebalancing](service-fabric-cluster-resource-manager-balancing.md) and [application upgrade](service-fabric-application-upgrade.md).</span></span> <span data-ttu-id="84c99-219">Durante estas operações (bem como durante o encerramento do serviço normal, como o que poderá ver se o serviço de Olá foi eliminado), é importante que Olá de relativamente do serviço de Olá `CancellationToken`.</span><span class="sxs-lookup"><span data-stu-id="84c99-219">During these operations (as well as during normal service shutdown, like you'd see if hello service was deleted), it is important that hello service respect hello `CancellationToken`.</span></span> <span data-ttu-id="84c99-220">Serviços que não processar corretamente o cancelamento irão ocorrer vários problemas.</span><span class="sxs-lookup"><span data-stu-id="84c99-220">Services that do not handle cancellation cleanly will experience several issues.</span></span> <span data-ttu-id="84c99-221">Em particular, estas operações serão lentas, uma vez que o Service Fabric aguarda Olá serviços toostop corretamente.</span><span class="sxs-lookup"><span data-stu-id="84c99-221">In particular, these operations will be slow since Service Fabric waits for hello services toostop gracefully.</span></span> <span data-ttu-id="84c99-222">Esta situação pode, em última análise levar toofailed atualizações que o limite de tempo e reverter.</span><span class="sxs-lookup"><span data-stu-id="84c99-222">This can ultimately lead toofailed upgrades that time out and roll back.</span></span> <span data-ttu-id="84c99-223">Token de cancelamento do falha toohonor Olá pode também fazer com que os clusters imbalanced porque nós obter frequente mas não podem ser reequilibrados serviços Olá, uma vez que demora demasiado tempo toomove-los noutro local.</span><span class="sxs-lookup"><span data-stu-id="84c99-223">Failure toohonor hello cancellation token can also cause imbalanced clusters because nodes get hot but hello services can't be rebalanced since it takes too long toomove them elsewhere.</span></span> 

<span data-ttu-id="84c99-224">Uma vez que os serviços de Olá com monitorização de estado, também é provável que estão a utilizar Olá [coleções fiável](service-fabric-reliable-services-reliable-collections.md).</span><span class="sxs-lookup"><span data-stu-id="84c99-224">Since hello services are stateful, it is also likely that they are using hello [Reliable Collections](service-fabric-reliable-services-reliable-collections.md).</span></span> <span data-ttu-id="84c99-225">No Service Fabric, quando um site primário é despromovido, um dos primeiros aspetos de Olá que ocorre é que o estado do acesso de escrita toohello subjacente foi revogado.</span><span class="sxs-lookup"><span data-stu-id="84c99-225">In Service Fabric, when a Primary is demoted, one of hello first things that happens is that write access toohello underlying state is revoked.</span></span> <span data-ttu-id="84c99-226">Esta situação origina tooa segundo conjunto de problemas que podem afetar o ciclo de vida do Olá serviço.</span><span class="sxs-lookup"><span data-stu-id="84c99-226">This leads tooa second set of issues that can impact hello service lifecycle.</span></span> <span data-ttu-id="84c99-227">coleções de Olá exceções retorno baseadas em temporização Olá e se está a ser movida réplica Olá ou encerramento.</span><span class="sxs-lookup"><span data-stu-id="84c99-227">hello collections return Exceptions based on hello timing and whether hello replica is being moved or shut down.</span></span> <span data-ttu-id="84c99-228">Estas exceções devem ser processadas corretamente.</span><span class="sxs-lookup"><span data-stu-id="84c99-228">These exceptions should be handled correctly.</span></span> <span data-ttu-id="84c99-229">Exceções acionadas por Service Fabric enquadram permanente [(`FabricException`)](https://docs.microsoft.com/en-us/dotnet/api/system.fabric.fabricexception?view=azure-dotnet) e transitório [(`FabricTransientException`)](https://docs.microsoft.com/en-us/dotnet/api/system.fabric.fabrictransientexception?view=azure-dotnet) categorias.</span><span class="sxs-lookup"><span data-stu-id="84c99-229">Exceptions thrown by Service Fabric fall into permanent [(`FabricException`)](https://docs.microsoft.com/en-us/dotnet/api/system.fabric.fabricexception?view=azure-dotnet) and transient [(`FabricTransientException`)](https://docs.microsoft.com/en-us/dotnet/api/system.fabric.fabrictransientexception?view=azure-dotnet) categories.</span></span> <span data-ttu-id="84c99-230">Permanentes exceções devem ser registadas e emitidas, enquanto exceções transitório Olá podem ser repetidas com base em algumas lógica de repetição.</span><span class="sxs-lookup"><span data-stu-id="84c99-230">Permanent exceptions should be logged and thrown, while hello transient exceptions may be retried based on some retry logic.</span></span>

<span data-ttu-id="84c99-231">Processamento de exceções de Olá que vêm da utilização de Olá `ReliableCollections` em conjunto com eventos de ciclo de vida do serviço é uma parte importante de teste e a validar um serviço fiável.</span><span class="sxs-lookup"><span data-stu-id="84c99-231">Handling hello exceptions that come from use of hello `ReliableCollections` in conjunction with service lifecycle events is an important part of testing and validating a Reliable Service.</span></span> <span data-ttu-id="84c99-232">Olá recomendação é sempre o serviço de carga toorun ao efetuar atualizações e [chaos testar](service-fabric-controlled-chaos.md) antes de implementar alguma vez tooproduction.</span><span class="sxs-lookup"><span data-stu-id="84c99-232">hello recommendation is always toorun your service under load while performing upgrades and [chaos testing](service-fabric-controlled-chaos.md) before ever deploying tooproduction.</span></span> <span data-ttu-id="84c99-233">Os passos básicos ajudam a garantir que o seu serviço é corretamente implementado e processa eventos de ciclo de vida corretamente.</span><span class="sxs-lookup"><span data-stu-id="84c99-233">These basic steps help ensure that your service is correctly implemented and handles lifecycle events correctly.</span></span>


## <a name="notes-on-service-lifecycle"></a><span data-ttu-id="84c99-234">Notas sobre o ciclo de vida do serviço</span><span class="sxs-lookup"><span data-stu-id="84c99-234">Notes on service lifecycle</span></span>
  - <span data-ttu-id="84c99-235">Ambos os Olá `RunAsync()` método e Olá `CreateServiceReplicaListeners/CreateServiceInstanceListeners` chamadas são opcionais.</span><span class="sxs-lookup"><span data-stu-id="84c99-235">Both hello `RunAsync()` method and hello `CreateServiceReplicaListeners/CreateServiceInstanceListeners` calls are optional.</span></span> <span data-ttu-id="84c99-236">Um serviço pode ter um dos mesmos, ambos ou nenhum.</span><span class="sxs-lookup"><span data-stu-id="84c99-236">A service may have one of them, both, or neither.</span></span> <span data-ttu-id="84c99-237">Por exemplo, se o serviço de Olá todos os respetivo trabalho em resposta toouser chamadas, não é necessário para o mesmo tooimplement `RunAsync()`.</span><span class="sxs-lookup"><span data-stu-id="84c99-237">For example, if hello service does all its work in response toouser calls, there is no need for it tooimplement `RunAsync()`.</span></span> <span data-ttu-id="84c99-238">Apenas Olá comunicação os serviços de escuta e o respetivo código associado são necessárias.</span><span class="sxs-lookup"><span data-stu-id="84c99-238">Only hello communication listeners and their associated code are necessary.</span></span> <span data-ttu-id="84c99-239">Da mesma forma, criar devolver os serviços de escuta de comunicação é opcional, como serviço Olá pode ter apenas em segundo plano toodo de trabalho e, por isso, só deverá tooimplement`RunAsync()`</span><span class="sxs-lookup"><span data-stu-id="84c99-239">Similarly, creating and returning communication listeners is optional, as hello service may have only background work toodo, and so only needs tooimplement `RunAsync()`</span></span>
  - <span data-ttu-id="84c99-240">É válido para um serviço toocomplete `RunAsync()` com êxito e retorno do mesmo.</span><span class="sxs-lookup"><span data-stu-id="84c99-240">It is valid for a service toocomplete `RunAsync()` successfully and return from it.</span></span> <span data-ttu-id="84c99-241">A conclusão não é uma condição de falha.</span><span class="sxs-lookup"><span data-stu-id="84c99-241">Completing is not a failure condition.</span></span> <span data-ttu-id="84c99-242">A concluir `RunAsync()` indica que o trabalho em segundo plano de Olá do serviço de Olá foi concluída.</span><span class="sxs-lookup"><span data-stu-id="84c99-242">Completing `RunAsync()` indicates that hello background work of hello service has completed.</span></span> <span data-ttu-id="84c99-243">Para os serviços fiáveis com monitorização de estado, `RunAsync()` denomina-se novamente se a réplica Olá foram despromovida de tooSecondary primário e, em seguida, promovido tooPrimary anterior.</span><span class="sxs-lookup"><span data-stu-id="84c99-243">For stateful reliable services, `RunAsync()` is called again if hello replica were demoted from Primary tooSecondary and then promoted back tooPrimary.</span></span>
  - <span data-ttu-id="84c99-244">Se um serviço sai do `RunAsync()` por argumentoutofrangeexception algumas exceção inesperada, isto constitui uma falha.</span><span class="sxs-lookup"><span data-stu-id="84c99-244">If a service exits from `RunAsync()` by throwing some unexpected exception, this constitutes a failure.</span></span> <span data-ttu-id="84c99-245">objeto de serviço Olá é encerrado e reportado um erro de estado de funcionamento.</span><span class="sxs-lookup"><span data-stu-id="84c99-245">hello service object is shut down and a health error reported.</span></span>
  - <span data-ttu-id="84c99-246">Enquanto não estiver não existe nenhum limite de tempo na devolução destes métodos, perder imediatamente Olá capacidade toowrite tooReliable coleções e, por conseguinte, não é possível concluir qualquer trabalho real.</span><span class="sxs-lookup"><span data-stu-id="84c99-246">While there is no time limit on returning from these methods, you immediately lose hello ability toowrite tooReliable Collections and therefore cannot complete any real work.</span></span> <span data-ttu-id="84c99-247">Recomenda-se que poderá devolve mais rapidamente possível após a receção de pedido de cancelamento Olá.</span><span class="sxs-lookup"><span data-stu-id="84c99-247">It is recommended that you return as quickly as possible upon receiving hello cancellation request.</span></span> <span data-ttu-id="84c99-248">Se o serviço não responder toothese API chamadas dentro de um período de tempo de que Service Fabric pode forçar a razoável termine o serviço.</span><span class="sxs-lookup"><span data-stu-id="84c99-248">If your service does not respond toothese API calls in a reasonable amount of time Service Fabric may forcibly terminate your service.</span></span> <span data-ttu-id="84c99-249">Normalmente, isto só ocorre durante as atualizações de aplicações ou quando um serviço está a ser eliminado.</span><span class="sxs-lookup"><span data-stu-id="84c99-249">Usually this only happens during application upgrades or when a service is being deleted.</span></span> <span data-ttu-id="84c99-250">Este tempo limite é de 15 minutos por predefinição.</span><span class="sxs-lookup"><span data-stu-id="84c99-250">This timeout is 15 minutes by default.</span></span>
  - <span data-ttu-id="84c99-251">Falhas na Olá `OnCloseAsync()` resultado de caminho no `OnAbort()` chamados que é uma oportunidade de melhor esforço de última oportunidade para Olá tooclean de serviço cópia de segurança e quaisquer recursos que possam tem reclamado de versão.</span><span class="sxs-lookup"><span data-stu-id="84c99-251">Failures in hello `OnCloseAsync()` path result in `OnAbort()` being called which is a last-chance best-effort opportunity for hello service tooclean up and release any resources that they have claimed.</span></span>

## <a name="next-steps"></a><span data-ttu-id="84c99-252">Passos seguintes</span><span class="sxs-lookup"><span data-stu-id="84c99-252">Next steps</span></span>
- [<span data-ttu-id="84c99-253">Introdução tooReliable serviços</span><span class="sxs-lookup"><span data-stu-id="84c99-253">Introduction tooReliable Services</span></span>](service-fabric-reliable-services-introduction.md)
- [<span data-ttu-id="84c99-254">Início rápido de serviços fiável</span><span class="sxs-lookup"><span data-stu-id="84c99-254">Reliable Services quick start</span></span>](service-fabric-reliable-services-quick-start.md)
- [<span data-ttu-id="84c99-255">Reliable Services avançadas de utilização</span><span class="sxs-lookup"><span data-stu-id="84c99-255">Reliable Services advanced usage</span></span>](service-fabric-reliable-services-advanced-usage.md)
