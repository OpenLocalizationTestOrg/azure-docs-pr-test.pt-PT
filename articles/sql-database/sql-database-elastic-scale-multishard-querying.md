---
title: "bases de dados aaaQuery em partição horizontal SQL do Azure | Microsoft Docs"
description: "Execute consultas em shards com biblioteca de cliente de base de dados elástica Olá."
services: sql-database
documentationcenter: 
manager: jhubbard
author: torsteng
editor: 
ms.assetid: a4379c15-f213-4026-ab6f-a450ee9d5758
ms.service: sql-database
ms.custom: scale out apps
ms.workload: sql-database
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 04/12/2016
ms.author: torsteng
ms.openlocfilehash: a1f0763935a6807b74aa9dec477714e8d117417d
ms.sourcegitcommit: 523283cc1b3c37c428e77850964dc1c33742c5f0
ms.translationtype: MT
ms.contentlocale: pt-PT
ms.lasthandoff: 10/06/2017
---
# <a name="multi-shard-querying"></a><span data-ttu-id="71c12-103">Consulta de várias partições horizontais</span><span class="sxs-lookup"><span data-stu-id="71c12-103">Multi-shard querying</span></span>
## <a name="overview"></a><span data-ttu-id="71c12-104">Descrição geral</span><span class="sxs-lookup"><span data-stu-id="71c12-104">Overview</span></span>
<span data-ttu-id="71c12-105">Com Olá [ferramentas de base de dados elástica](sql-database-elastic-scale-introduction.md), pode criar soluções de base de dados em partição horizontal.</span><span class="sxs-lookup"><span data-stu-id="71c12-105">With hello [Elastic Database tools](sql-database-elastic-scale-introduction.md), you can create sharded database solutions.</span></span> <span data-ttu-id="71c12-106">**Consulta de partições horizontais Multi** é utilizada para tarefas, tais como recolha/relatórios de dados que requerem a execução de uma consulta que é alongada entre várias partições horizontais.</span><span class="sxs-lookup"><span data-stu-id="71c12-106">**Multi-shard querying** is used for tasks such as data collection/reporting that require running a query that stretches across several shards.</span></span> <span data-ttu-id="71c12-107">(Contraste isto demasiado[encaminhamento de dados dependentes](sql-database-elastic-scale-data-dependent-routing.md), que efetua todo trabalho um ID de partição horizontal único.)</span><span class="sxs-lookup"><span data-stu-id="71c12-107">(Contrast this too[data-dependent routing](sql-database-elastic-scale-data-dependent-routing.md), which performs all work on a single shard.)</span></span> 

1. <span data-ttu-id="71c12-108">Obter um [ **RangeShardMap** ](https://msdn.microsoft.com/library/azure/dn807318.aspx) ou [ **ListShardMap** ](https://msdn.microsoft.com/library/azure/dn807370.aspx) utilizando Olá [ **TryGetRangeShardMap** ](https://msdn.microsoft.com/library/azure/microsoft.azure.sqldatabase.elasticscale.shardmanagement.shardmapmanager.trygetrangeshardmap.aspx), Olá [ **TryGetListShardMap**](https://msdn.microsoft.com/library/azure/microsoft.azure.sqldatabase.elasticscale.shardmanagement.shardmapmanager.trygetlistshardmap.aspx), ou Olá [ **GetShardMap** ](https://msdn.microsoft.com/library/azure/microsoft.azure.sqldatabase.elasticscale.shardmanagement.shardmapmanager.getshardmap.aspx) método.</span><span class="sxs-lookup"><span data-stu-id="71c12-108">Get a [**RangeShardMap**](https://msdn.microsoft.com/library/azure/dn807318.aspx) or [**ListShardMap**](https://msdn.microsoft.com/library/azure/dn807370.aspx) using hello [**TryGetRangeShardMap**](https://msdn.microsoft.com/library/azure/microsoft.azure.sqldatabase.elasticscale.shardmanagement.shardmapmanager.trygetrangeshardmap.aspx), hello [**TryGetListShardMap**](https://msdn.microsoft.com/library/azure/microsoft.azure.sqldatabase.elasticscale.shardmanagement.shardmapmanager.trygetlistshardmap.aspx), or hello [**GetShardMap**](https://msdn.microsoft.com/library/azure/microsoft.azure.sqldatabase.elasticscale.shardmanagement.shardmapmanager.getshardmap.aspx) method.</span></span> <span data-ttu-id="71c12-109">Consulte [ **construir um ShardMapManager** ](sql-database-elastic-scale-shard-map-management.md#constructing-a-shardmapmanager) e [ **obter um RangeShardMap ou ListShardMap**](sql-database-elastic-scale-shard-map-management.md#get-a-rangeshardmap-or-listshardmap).</span><span class="sxs-lookup"><span data-stu-id="71c12-109">See [**Constructing a ShardMapManager**](sql-database-elastic-scale-shard-map-management.md#constructing-a-shardmapmanager) and [**Get a RangeShardMap or ListShardMap**](sql-database-elastic-scale-shard-map-management.md#get-a-rangeshardmap-or-listshardmap).</span></span>
2. <span data-ttu-id="71c12-110">Criar um  **[MultiShardConnection](https://msdn.microsoft.com/library/azure/microsoft.azure.sqldatabase.elasticscale.query.multishardconnection.aspx)**  objeto.</span><span class="sxs-lookup"><span data-stu-id="71c12-110">Create a **[MultiShardConnection](https://msdn.microsoft.com/library/azure/microsoft.azure.sqldatabase.elasticscale.query.multishardconnection.aspx)** object.</span></span>
3. <span data-ttu-id="71c12-111">Criar um  **[MultiShardCommand](https://msdn.microsoft.com/library/azure/microsoft.azure.sqldatabase.elasticscale.query.multishardcommand.aspx)**.</span><span class="sxs-lookup"><span data-stu-id="71c12-111">Create a **[MultiShardCommand](https://msdn.microsoft.com/library/azure/microsoft.azure.sqldatabase.elasticscale.query.multishardcommand.aspx)**.</span></span> 
4. <span data-ttu-id="71c12-112">Conjunto Olá  **[propriedade CommandText](https://msdn.microsoft.com/library/azure/microsoft.azure.sqldatabase.elasticscale.query.multishardcommand.commandtext.aspx#P:Microsoft.Azure.SqlDatabase.ElasticScale.Query.MultiShardCommand.CommandText)**  tooa comando T-SQL.</span><span class="sxs-lookup"><span data-stu-id="71c12-112">Set hello **[CommandText property](https://msdn.microsoft.com/library/azure/microsoft.azure.sqldatabase.elasticscale.query.multishardcommand.commandtext.aspx#P:Microsoft.Azure.SqlDatabase.ElasticScale.Query.MultiShardCommand.CommandText)** tooa T-SQL command.</span></span>
5. <span data-ttu-id="71c12-113">Executar o comando de Olá ao chamar Olá  **[método ExecuteReader](https://msdn.microsoft.com/library/azure/microsoft.azure.sqldatabase.elasticscale.query.multishardcommand.executereader.aspx)**.</span><span class="sxs-lookup"><span data-stu-id="71c12-113">Execute hello command by calling hello **[ExecuteReader method](https://msdn.microsoft.com/library/azure/microsoft.azure.sqldatabase.elasticscale.query.multishardcommand.executereader.aspx)**.</span></span>
6. <span data-ttu-id="71c12-114">Ver resultados de Olá utilizando Olá  **[MultiShardDataReader classe](https://msdn.microsoft.com/library/azure/microsoft.azure.sqldatabase.elasticscale.query.multisharddatareader.aspx)**.</span><span class="sxs-lookup"><span data-stu-id="71c12-114">View hello results using hello **[MultiShardDataReader class](https://msdn.microsoft.com/library/azure/microsoft.azure.sqldatabase.elasticscale.query.multisharddatareader.aspx)**.</span></span> 

## <a name="example"></a><span data-ttu-id="71c12-115">Exemplo</span><span class="sxs-lookup"><span data-stu-id="71c12-115">Example</span></span>
<span data-ttu-id="71c12-116">Olá seguinte código ilustra a utilização de Olá de partições horizontais multi consulta utilizando um determinado **ShardMap** denominado *myShardMap*.</span><span class="sxs-lookup"><span data-stu-id="71c12-116">hello following code illustrates hello usage of multi-shard querying using a given **ShardMap** named *myShardMap*.</span></span> 

    using (MultiShardConnection conn = new MultiShardConnection( 
                                        myShardMap.GetShards(), 
                                        myShardConnectionString) 
          ) 
    { 
    using (MultiShardCommand cmd = conn.CreateCommand())
           { 
            cmd.CommandText = "SELECT c1, c2, c3 FROM ShardedTable"; 
            cmd.CommandType = CommandType.Text; 
            cmd.ExecutionOptions = MultiShardExecutionOptions.IncludeShardNameColumn; 
            cmd.ExecutionPolicy = MultiShardExecutionPolicy.PartialResults; 

            using (MultiShardDataReader sdr = cmd.ExecuteReader()) 
                { 
                    while (sdr.Read())
                        { 
                            var c1Field = sdr.GetString(0); 
                            var c2Field = sdr.GetFieldValue<int>(1); 
                            var c3Field = sdr.GetFieldValue<Int64>(2);
                        } 
                 } 
           } 
    } 


<span data-ttu-id="71c12-117">Uma principal diferença é construção Olá de ligações de várias partições horizontais.</span><span class="sxs-lookup"><span data-stu-id="71c12-117">A key difference is hello construction of multi-shard connections.</span></span> <span data-ttu-id="71c12-118">Onde **SqlConnection** funciona numa base de dados único, hello **MultiShardConnection** demora um ***coleção de partições horizontais*** como entrada.</span><span class="sxs-lookup"><span data-stu-id="71c12-118">Where **SqlConnection** operates on a single database, hello **MultiShardConnection** takes a ***collection of shards*** as its input.</span></span> <span data-ttu-id="71c12-119">Povoar a colecção de Olá de partições horizontais de um mapa de partições horizontais.</span><span class="sxs-lookup"><span data-stu-id="71c12-119">Populate hello collection of shards from a shard map.</span></span> <span data-ttu-id="71c12-120">consulta de Olá, em seguida, é executada numa coleção de Olá de partições horizontais utilizando **UNION ALL** semântica tooassemble um único resultado geral.</span><span class="sxs-lookup"><span data-stu-id="71c12-120">hello query is then executed on hello collection of shards using **UNION ALL** semantics tooassemble a single overall result.</span></span> <span data-ttu-id="71c12-121">Opcionalmente, pode ser adicionado toohello saída utilizando Olá nome Olá de partições horizontais olá onde linha Olá tem origem **ExecutionOptions** propriedade no comando.</span><span class="sxs-lookup"><span data-stu-id="71c12-121">Optionally, hello name of hello shard where hello row originates from can be added toohello output using hello **ExecutionOptions** property on command.</span></span> 

<span data-ttu-id="71c12-122">Tenha em atenção chamada Olá demasiado**myShardMap.GetShards()**.</span><span class="sxs-lookup"><span data-stu-id="71c12-122">Note hello call too**myShardMap.GetShards()**.</span></span> <span data-ttu-id="71c12-123">Este método obtém todas as partições horizontais do mapa de partições horizontais Olá e fornece uma forma fácil toorun uma consulta em todas as bases de dados relevantes.</span><span class="sxs-lookup"><span data-stu-id="71c12-123">This method retrieves all shards from hello shard map and provides an easy way toorun a query across all relevant databases.</span></span> <span data-ttu-id="71c12-124">Olá coleção de partições horizontais para uma consulta de partições horizontais multi pode ser avançada mais efetuando uma LINQ consultar sobre recolha de Olá devolvida da chamada de Olá demasiado**myShardMap.GetShards()**.</span><span class="sxs-lookup"><span data-stu-id="71c12-124">hello collection of shards for a multi-shard query can be refined further by performing a LINQ query over hello collection returned from hello call too**myShardMap.GetShards()**.</span></span> <span data-ttu-id="71c12-125">Em combinação com a política de resultados parciais Olá, a capacidade atual da Olá na consulta de partições horizontais multi foi concebida toowork bem para dezenas segurança toohundreds de partições horizontais.</span><span class="sxs-lookup"><span data-stu-id="71c12-125">In combination with hello partial results policy, hello current capability in multi-shard querying has been designed toowork well for tens up toohundreds of shards.</span></span>

<span data-ttu-id="71c12-126">Uma limitação com várias partições horizontais consulta está atualmente a falta de Olá de validação para shards e shardlets são consultadas.</span><span class="sxs-lookup"><span data-stu-id="71c12-126">A limitation with multi-shard querying is currently hello lack of validation for shards and shardlets that are queried.</span></span> <span data-ttu-id="71c12-127">Enquanto o encaminhamento de dados dependentes verifica que um ID de partição horizontal especificado faz parte do mapa de partições horizontais Olá momento Olá da consulta, consultas de partições horizontais multi não executar esta verificação.</span><span class="sxs-lookup"><span data-stu-id="71c12-127">While data-dependent routing verifies that a given shard is part of hello shard map at hello time of querying, multi-shard queries do not perform this check.</span></span> <span data-ttu-id="71c12-128">Isto pode levar a consultas de partições horizontais o toomulti em execução em bases de dados que foram removidas do mapa de partições horizontais Olá.</span><span class="sxs-lookup"><span data-stu-id="71c12-128">This can lead toomulti-shard queries running on databases that have  been removed from hello shard map.</span></span>

## <a name="multi-shard-queries-and-split-merge-operations"></a><span data-ttu-id="71c12-129">Operações de divisão de intercalação e consultas de várias partições horizontais</span><span class="sxs-lookup"><span data-stu-id="71c12-129">Multi-shard queries and split-merge operations</span></span>
<span data-ttu-id="71c12-130">Consultas de partições horizontais multi não verificar se shardlets na base de dados consultado Olá participam em operações de divisão de intercalação em curso.</span><span class="sxs-lookup"><span data-stu-id="71c12-130">Multi-shard queries do not verify whether shardlets on hello queried database are participating in ongoing split-merge operations.</span></span> <span data-ttu-id="71c12-131">(Consulte [dimensionamento utilizando a ferramenta de Olá intercalação de divisão de base de dados elástica](sql-database-elastic-scale-overview-split-and-merge.md).) Esta funcionalidade pode originar tooinconsistencies onde as linhas de Olá mesmo shardlet Mostrar várias bases de dados no Olá mesma consulta de várias partições horizontais.</span><span class="sxs-lookup"><span data-stu-id="71c12-131">(See [Scaling using hello Elastic Database split-merge tool](sql-database-elastic-scale-overview-split-and-merge.md).) This can lead tooinconsistencies where rows from hello same shardlet show for multiple databases in hello same multi-shard query.</span></span> <span data-ttu-id="71c12-132">Tenha em conta estas limitações e considere a ser drenado e em curso divisão intercalação operações e alterações toohello partições horizontais mapa ao efetuar consultas de várias partições horizontais.</span><span class="sxs-lookup"><span data-stu-id="71c12-132">Be aware of these limitations and consider draining ongoing split-merge operations and changes toohello shard map while performing multi-shard queries.</span></span>

[!INCLUDE [elastic-scale-include](../../includes/elastic-scale-include.md)]

## <a name="see-also"></a><span data-ttu-id="71c12-133">Consultar também</span><span class="sxs-lookup"><span data-stu-id="71c12-133">See also</span></span>
<span data-ttu-id="71c12-134">**[SqlClient](http://msdn.microsoft.com/library/System.Data.SqlClient.aspx)**  classes e métodos.</span><span class="sxs-lookup"><span data-stu-id="71c12-134">**[System.Data.SqlClient](http://msdn.microsoft.com/library/System.Data.SqlClient.aspx)** classes and methods.</span></span>

<span data-ttu-id="71c12-135">Gerir shards utilizando Olá [biblioteca de clientes de base de dados elástica](sql-database-elastic-database-client-library.md).</span><span class="sxs-lookup"><span data-stu-id="71c12-135">Manage shards using hello [Elastic Database client library](sql-database-elastic-database-client-library.md).</span></span> <span data-ttu-id="71c12-136">Inclui um espaço de nomes chamado [Microsoft.Azure.SqlDatabase.ElasticScale.Query](https://msdn.microsoft.com/library/azure/microsoft.azure.sqldatabase.elasticscale.query.aspx) que fornece Olá capacidade tooquery shards vários utilizando uma única consulta e o resultado.</span><span class="sxs-lookup"><span data-stu-id="71c12-136">Includes a  namespace called [Microsoft.Azure.SqlDatabase.ElasticScale.Query](https://msdn.microsoft.com/library/azure/microsoft.azure.sqldatabase.elasticscale.query.aspx) that provides hello ability tooquery multiple shards using a single query and result.</span></span> <span data-ttu-id="71c12-137">Fornece uma abstração de consulta através de uma coleção de partições horizontais.</span><span class="sxs-lookup"><span data-stu-id="71c12-137">It provides a querying abstraction over a collection of shards.</span></span> <span data-ttu-id="71c12-138">Também fornece as políticas de execução alternativo, resultados parciais em particular, toodeal com falhas ao consultar através de várias partições horizontais.</span><span class="sxs-lookup"><span data-stu-id="71c12-138">It also provides alternative execution policies, in particular partial results, toodeal with failures when querying over many shards.</span></span>  

